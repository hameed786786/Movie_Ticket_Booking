<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theater Dashboard - TicketHub</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1><a href="/">ðŸŽ¬ TicketHub</a></h1>
            </div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/theater-dashboard.html">Dashboard</a>
                <div class="user-menu" id="userMenu">
                    <span id="userName"></span>
                    <a href="#" id="logoutBtn">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="padding: 2rem 0;">
        <div class="dashboard-header">
            <h1>ðŸŽ­ Theater Dashboard</h1>
            <div>
                <button class="btn btn-primary" onclick="showAddMovieModal()">+ Add Movie</button>
                <button class="btn btn-secondary" onclick="showAddShowModal()">+ Add Show</button>
            </div>
        </div>
        
        <div id="theaterInfo" class="stats-grid">
            <div class="stat-card">
                <div class="value" id="totalMovies">0</div>
                <div class="label">Movies Added</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalShows">0</div>
                <div class="label">Active Shows</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalScreens">0</div>
                <div class="label">Screens</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('movies')">Movies</button>
            <button class="tab-btn" onclick="switchTab('shows')">Shows</button>
            <button class="tab-btn" onclick="switchTab('screens')">Screens</button>
        </div>
        
        <div id="moviesTab" class="tab-content active">
            <div id="moviesList">
                <div class="loading">Loading movies...</div>
            </div>
        </div>
        
        <div id="showsTab" class="tab-content">
            <div id="showsList">
                <div class="loading">Loading shows...</div>
            </div>
        </div>
        
        <div id="screensTab" class="tab-content">
            <button class="btn btn-primary" style="margin-bottom: 1rem;" onclick="showAddScreenModal()">+ Add Screen</button>
            <div id="screensList">
                <div class="loading">Loading screens...</div>
            </div>
        </div>
    </div>

    <!-- Add Movie Modal -->
    <div id="addMovieModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Movie</h3>
                <button class="modal-close" onclick="closeModal('addMovieModal')">&times;</button>
            </div>
            <form id="addMovieForm">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea name="description" rows="3" required></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Duration (minutes) *</label>
                        <input type="number" name="duration" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Language *</label>
                        <input type="text" name="language" required placeholder="English, Hindi, etc.">
                    </div>
                </div>
                <div class="form-group">
                    <label>Genre (comma separated) *</label>
                    <input type="text" name="genre" required placeholder="Action, Drama, Comedy">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Release Date *</label>
                        <input type="date" name="releaseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Certificate</label>
                        <select name="certificate">
                            <option value="U">U - Universal</option>
                            <option value="UA" selected>UA - Parental Guidance</option>
                            <option value="A">A - Adults Only</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Poster URL</label>
                    <input type="url" name="posterUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Director</label>
                    <input type="text" name="director">
                </div>
                <div id="movieFormAlert"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Movie</button>
            </form>
        </div>
    </div>

    <!-- Add Show Modal -->
    <div id="addShowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Show</h3>
                <button class="modal-close" onclick="closeModal('addShowModal')">&times;</button>
            </div>
            <form id="addShowForm">
                <div class="form-group">
                    <label>Movie *</label>
                    <select name="movieId" id="showMovieSelect" required>
                        <option value="">Select a movie</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Screen *</label>
                    <select name="screenNumber" id="showScreenSelect" required>
                        <option value="">Select a screen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Show Date & Time *</label>
                    <input type="datetime-local" name="showTime" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Regular â‚¹</label>
                        <input type="number" name="regularPrice" value="150" min="0">
                    </div>
                    <div class="form-group">
                        <label>Premium â‚¹</label>
                        <input type="number" name="premiumPrice" value="250" min="0">
                    </div>
                    <div class="form-group">
                        <label>VIP â‚¹</label>
                        <input type="number" name="vipPrice" value="400" min="0">
                    </div>
                </div>
                <div id="showFormAlert"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Show</button>
            </form>
        </div>
    </div>

    <!-- Add Screen Modal -->
    <div id="addScreenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Screen</h3>
                <button class="modal-close" onclick="closeModal('addScreenModal')">&times;</button>
            </div>
            <form id="addScreenForm">
                <div class="form-group">
                    <label>Screen Name *</label>
                    <input type="text" name="name" required placeholder="e.g., IMAX, Dolby Atmos">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Number of Rows *</label>
                        <input type="number" name="rows" required min="1" max="26" value="10">
                    </div>
                    <div class="form-group">
                        <label>Seats per Row *</label>
                        <input type="number" name="seatsPerRow" required min="1" max="30" value="15">
                    </div>
                </div>
                <p class="form-hint">Total seats: <span id="totalSeatsPreview">150</span></p>
                <div id="screenFormAlert"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Screen</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Check auth
        if (!Auth.isLoggedIn()) {
            window.location.href = '/login.html';
        }
        
        const user = Auth.getUser();
        if (user.role !== 'theater' && user.role !== 'admin') {
            alert('Access denied. Theater owner privileges required.');
            window.location.href = '/';
        }
        
        document.getElementById('userName').textContent = user.name;
        
        let theaterData = null;
        let moviesData = [];
        let showsData = [];
        
        // Load theater data
        async function loadTheater() {
            try {
                theaterData = await api.get('/theaters/my/theater');
                document.getElementById('totalScreens').textContent = theaterData.screens?.length || 0;
                loadMovies();
                loadShows();
                loadScreens();
            } catch (error) {
                console.error('Error loading theater:', error);
            }
        }
        
        // Load movies
        async function loadMovies() {
            try {
                moviesData = await api.get('/movies');
                document.getElementById('totalMovies').textContent = moviesData.length;
                
                const container = document.getElementById('moviesList');
                if (moviesData.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No movies added yet.</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Poster</th>
                                    <th>Title</th>
                                    <th>Genre</th>
                                    <th>Duration</th>
                                    <th>Language</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${moviesData.map(movie => `
                                    <tr>
                                        <td>
                                            <img src="${movie.posterUrl || '/images/default-poster.jpg'}" 
                                                 style="width: 50px; height: 75px; object-fit: cover; border-radius: 5px;"
                                                 onerror="this.src='/images/default-poster.jpg'">
                                        </td>
                                        <td>${movie.title}</td>
                                        <td>${movie.genre.join(', ')}</td>
                                        <td>${movie.duration} min</td>
                                        <td>${movie.language}</td>
                                        <td>
                                            <button class="btn btn-danger" onclick="deleteMovie('${movie._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Update movie select in show form
                const movieSelect = document.getElementById('showMovieSelect');
                movieSelect.innerHTML = '<option value="">Select a movie</option>' +
                    moviesData.map(m => `<option value="${m._id}">${m.title}</option>`).join('');
                    
            } catch (error) {
                document.getElementById('moviesList').innerHTML = `<p class="alert alert-error">${error.message}</p>`;
            }
        }
        
        // Load shows
        async function loadShows() {
            if (!theaterData) return;
            
            try {
                showsData = await api.get(`/shows/theater/${theaterData._id}`);
                document.getElementById('totalShows').textContent = showsData.length;
                
                const container = document.getElementById('showsList');
                if (showsData.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No shows scheduled.</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Movie</th>
                                    <th>Screen</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Pricing</th>
                                    <th>Seats</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${showsData.map(show => `
                                    <tr>
                                        <td>${show.movie?.title || 'N/A'}</td>
                                        <td>Screen ${show.screenNumber}</td>
                                        <td>${UI.formatDate(show.showTime)}</td>
                                        <td>${UI.formatTime(show.showTime)}</td>
                                        <td>â‚¹${show.pricing.regular} / â‚¹${show.pricing.premium} / â‚¹${show.pricing.vip}</td>
                                        <td>${show.availableSeats}/${show.totalSeats}</td>
                                        <td>
                                            <button class="btn btn-danger" onclick="deleteShow('${show._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                document.getElementById('showsList').innerHTML = `<p class="alert alert-error">${error.message}</p>`;
            }
        }
        
        // Load screens
        function loadScreens() {
            if (!theaterData || !theaterData.screens) return;
            
            const container = document.getElementById('screensList');
            if (theaterData.screens.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No screens added yet.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="stats-grid">
                    ${theaterData.screens.map(screen => `
                        <div class="stat-card">
                            <div class="value">${screen.name || 'Screen ' + screen.screenNumber}</div>
                            <div class="label">
                                ${screen.rows} rows Ã— ${screen.seatsPerRow} seats = ${screen.totalSeats} total
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update screen select
            const screenSelect = document.getElementById('showScreenSelect');
            screenSelect.innerHTML = '<option value="">Select a screen</option>' +
                theaterData.screens.map(s => `<option value="${s.screenNumber}">${s.name || 'Screen ' + s.screenNumber} (${s.totalSeats} seats)</option>`).join('');
        }
        
        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }
        
        // Modal functions
        function showAddMovieModal() {
            document.getElementById('addMovieModal').classList.add('active');
        }
        
        function showAddShowModal() {
            if (!theaterData?.screens?.length) {
                alert('Please add a screen first before adding shows.');
                return;
            }
            document.getElementById('addShowModal').classList.add('active');
        }
        
        function showAddScreenModal() {
            document.getElementById('addScreenModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Add Movie
        document.getElementById('addMovieForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const alertEl = document.getElementById('movieFormAlert');
            
            try {
                await api.post('/movies', {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    duration: parseInt(formData.get('duration')),
                    language: formData.get('language'),
                    genre: formData.get('genre').split(',').map(g => g.trim()),
                    releaseDate: formData.get('releaseDate'),
                    certificate: formData.get('certificate'),
                    posterUrl: formData.get('posterUrl') || undefined,
                    director: formData.get('director') || undefined
                });
                
                closeModal('addMovieModal');
                e.target.reset();
                loadMovies();
            } catch (error) {
                alertEl.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });
        
        // Add Show
        document.getElementById('addShowForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const alertEl = document.getElementById('showFormAlert');
            
            try {
                await api.post('/shows', {
                    movieId: formData.get('movieId'),
                    theaterId: theaterData._id,
                    screenNumber: parseInt(formData.get('screenNumber')),
                    showTime: formData.get('showTime'),
                    pricing: {
                        regular: parseInt(formData.get('regularPrice')),
                        premium: parseInt(formData.get('premiumPrice')),
                        vip: parseInt(formData.get('vipPrice'))
                    }
                });
                
                closeModal('addShowModal');
                e.target.reset();
                loadShows();
            } catch (error) {
                alertEl.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });
        
        // Add Screen
        document.getElementById('addScreenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const alertEl = document.getElementById('screenFormAlert');
            
            try {
                await api.post(`/theaters/${theaterData._id}/screens`, {
                    name: formData.get('name'),
                    rows: parseInt(formData.get('rows')),
                    seatsPerRow: parseInt(formData.get('seatsPerRow'))
                });
                
                closeModal('addScreenModal');
                e.target.reset();
                loadTheater();
            } catch (error) {
                alertEl.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });
        
        // Update total seats preview
        document.querySelectorAll('#addScreenForm input[name="rows"], #addScreenForm input[name="seatsPerRow"]').forEach(input => {
            input.addEventListener('input', () => {
                const rows = parseInt(document.querySelector('#addScreenForm input[name="rows"]').value) || 0;
                const seats = parseInt(document.querySelector('#addScreenForm input[name="seatsPerRow"]').value) || 0;
                document.getElementById('totalSeatsPreview').textContent = rows * seats;
            });
        });
        
        // Delete functions
        async function deleteMovie(movieId) {
            if (!confirm('Are you sure you want to delete this movie?')) return;
            try {
                await api.delete(`/movies/${movieId}`);
                loadMovies();
            } catch (error) {
                alert(error.message);
            }
        }
        
        async function deleteShow(showId) {
            if (!confirm('Are you sure you want to delete this show?')) return;
            try {
                await api.delete(`/shows/${showId}`);
                loadShows();
            } catch (error) {
                alert(error.message);
            }
        }
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Initialize
        loadTheater();
    </script>
</body>
</html>
